<!DOCTYPE html>
<html>
<head>
<title>README</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h1>OO第十次作业README</h1>
<p><del>嘛。。以后要拿中文写文档了呢</del></p>
<p><a href="http://misaka-oss.oss-cn-beijing.aliyuncs.com/cs/oo/OO%E7%AC%AC10%E6%AC%A1%E4%BD%9C%E4%B8%9A%E6%8C%87%E5%AF%BC%E4%B9%A6.pdf">点击就送指导书</a></p>
<h2>运行环境</h2>
<ul>
<li>java 1.8.0_112  
</li>
<li>javac 1.8.0_112</li>
<li>git 2.7.4</li>
<li>编写者操作系统 Windows 10 Professional</li>
<li>基本硬件配置 4core i7 CPU, 8G RAM</li>
</ul>
<h2>需求分析与设计</h2>
<h3>需求</h3>
<ul>
<li>模拟一个出租车系统</li>
<li>出租车按照指定的模式自行行进</li>
<li>出租车调度中心按照指定的模式进行分配调度</li>
<li>支持通过控制台（或者其他形式）状态访问等操作</li>
<li>配合GUI详细展示整个动态效果 </li>
</ul>
<h3>架构布置</h3>
<h4>路网(FlowMap)</h4>
<ul>
<li>路网仅用于存储程序所使用的<strong>路网的拓扑结构信息</strong>。</li>
<li>路网支持<strong>节点和边的一些相关查询</strong>（边存在性，点相关的边等）。</li>
<li>路网对象提供<strong>路网结构数据导出</strong>接口（<strong>用于给GUI组件快速提供路网结构数据</strong>）。</li>
<li>【新增】支持流量信息对外查询</li>
<li>支持最短路计算（内置进了该部分）</li>
<li>支持道路增删</li>
</ul>
<h4>流量处理单元（MapFlow）</h4>
<ul>
<li>支持<strong>流量累积统计</strong></li>
<li>支持<strong>上一个时间单元流量查询</strong></li>
<li>通过外部定时器支持定时切换时间片</li>
</ul>
<h4>出租车(Taxi)</h4>
<ul>
<li>出租车为<strong>出租车动作模拟的基本单位</strong>，只负责单个出租车本身的行为模拟。</li>
<li>可以查询出租车各项指标和状态。</li>
<li>当位置和状态发生改变时，<strong>可以通过事件机制实时触发自定义动作</strong>。</li>
<li>可以进行请求<strong>任务的分配</strong>，且带有<strong>线程安全保护措施</strong>。</li>
</ul>
<h4>出租车调度系统(TaxiSystem)</h4>
<ul>
<li>出租车调度系统负责从外部<strong>接受用户请求</strong>，并<strong>按照规定的策略尝试分配给出租车</strong>。</li>
<li>出租车调度系统根据出租车所提供的事件机制，<strong>监测出租车的变化，并提供相关的查询服务</strong>。</li>
<li>出租车调度系统需要<strong>能跟GUI进行一些数据对接</strong>以实现动态渲染视图。</li>
</ul>
<h3>类图</h3>
<h4>路网结构相关</h4>
<p><img src="http://misaka-oss.oss-cn-beijing.aliyuncs.com/others/oo_10_map.png" /></p>
<h4>出租车系统</h4>
<p><img src="http://misaka-oss.oss-cn-beijing.aliyuncs.com/others/oo_10_system.png" /></p>
<h4>请求</h4>
<p><img src="http://misaka-oss.oss-cn-beijing.aliyuncs.com/others/oo_10_request.png" /></p>
<h2>系统设定</h2>
<h3>路网</h3>
<ul>
<li>路网横纵坐标编号均从<code>0</code>到<code>79</code>。</li>
<li>相邻点之间的连接状况</li>
</ul>
<h3>出租车</h3>
<h4>编号</h4>
<ul>
<li>出租车编号从<code>1</code>到<code>100</code></li>
</ul>
<h4>状态</h4>
<ul>
<li><strong>FREE</strong> 自由状态，可以接收服务请求。</li>
<li><strong>GOING_TO_SERVICE</strong> 等待服务状态，该车正在赶往乘客位置（到达位置后等待的1s内也处于这一状态）。</li>
<li><strong>IN_SERVICE</strong> 服务状态，该车正在载着乘客赶往目的地。</li>
<li><strong>STOPPED</strong> 停止状态，到达目的地后或随机行进20s后的1s修整时处于这一状态。 </li>
</ul>
<h4>方向</h4>
<ul>
<li><strong>UP</strong> 向上，行为为<code>x -= 1</code></li>
<li><strong>DOWN</strong> 向下，行为为<code>x += 1</code></li>
<li><strong>LEFT</strong> 向左，行为为<code>y -= 1</code></li>
<li><strong>RIGHT</strong> 向右，行为为<code>y += 1</code></li>
</ul>
<h4>红绿灯</h4>
<ul>
<li><strong>RED</strong> 红灯</li>
<li><strong>GREEN</strong> 绿灯</li>
</ul>
<h4>路口状态</h4>
<ul>
<li><strong>NONE</strong> 无红绿灯（对应值<code>0</code>）</li>
<li><strong>EAST_WEST</strong> 东西向绿灯（对应值<code>1</code>）</li>
<li><strong>NORTH_SOUTH</strong> 南北向绿灯（对应值<code>2</code>）</li>
</ul>
<h2>使用</h2>
<h3>地图输入</h3>
<p>格式参见<a href="http://misaka-oss.oss-cn-beijing.aliyuncs.com/cs/oo/OO%E7%AC%AC10%E6%AC%A1%E4%BD%9C%E4%B8%9A%E6%8C%87%E5%AF%BC%E4%B9%A6.pdf">指导书</a>，文件名<code>map.txt</code>。</p>
<p><strong>地图仍采用单独文件输入，而不是load_file输入</strong></p>
<h3>信号灯输入</h3>
<p>格式参见<a href="http://misaka-oss.oss-cn-beijing.aliyuncs.com/cs/oo/OO%E7%AC%AC10%E6%AC%A1%E4%BD%9C%E4%B8%9A%E6%8C%87%E5%AF%BC%E4%B9%A6.pdf">指导书</a>，文件名<code>traffic.txt</code>。</p>
<p>格式为80x80的矩阵，包含数字<code>0</code>、<code>1</code>、<code>2</code>（<strong>对应意义参见路口状态的设定</strong>）</p>
<p><strong>信号灯采用单独文件输入，而不是load_file输入</strong></p>
<p>此外：</p>
<ul>
<li>如果信号灯输入文件格式有异常，将在控制台上进行反馈</li>
<li>如果有异常，将跳过这一块<strong>直接继续执行接下来的程序，且视为所有路口均无信号灯（保证操作原子性）</strong>。 </li>
</ul>
<h3>load_file输入</h3>
<ul>
<li>在程序的一开始，基础数据加载完毕后，可以输入<strong>一条</strong><code>load_file</code>指令</li>
<li>格式为<code>load_file &lt;filename&gt;</code>，例如<code>load_file 1.txt</code>表示加载<code>1.txt</code>（<strong>绝对路径相对路径均支持</strong>）</li>
<li><code>load_file</code>指令不输入或者格式错误（在控制台上有操作反馈），<strong>除了不会加载文件内数据外，不影响程序继续执行</strong>。</li>
</ul>
<h4>load_file文件内格式</h4>
<ul>
<li>
<code>No.&lt;id&gt; &lt;status&gt; &lt;credit&gt; &lt;position&gt;</code> 表示将第<code>id</code>号出租车，状态设置为<code>status</code>，信用度设置为<code>credit</code>，位置设置为<code>position</code>，其中：
<ul>
<li><code>id</code>需要保证合法，即<code>0</code>~<code>99</code></li>
<li>为了避免&quot;滴滴打鬼&quot;情况出现，本命令中<strong><code>status</code>只允许设置为<code>FREE</code>和<code>STOPPED</code></strong>（<code>STOPPED</code>将休止后继续恢复<code>FREE</code>状态）</li>
<li><code>credit</code>请在<code>Integer</code>范围内（<del>其实可以设置为负数</del>）</li>
<li><code>position</code>请确保合法</li>
</ul>
</li>
<li>
<code>No.&lt;id&gt; &lt;status&gt; &lt;request&gt;</code>，表示将第<code>id</code>号出租车，状态设置为<code>status</code>，且当前单子设置为<code>request</code>，其中：
<ul>
<li><code>id</code>需要保证合法，即<code>0</code>~<code>99</code></li>
<li><strong><code>status</code>四种状态均可</strong>（由于一并设置了当前订单，故不会出现&quot;滴滴打鬼&quot;现象，可以较好模拟中间情况）</li>
<li><code>request</code>即为一般的出租车请求格式，代表当前处理的订单</li>
</ul>
</li>
<li>一般的出租车请求格式（具体格式见demo或者下文）</li>
</ul>
<h4>load_file demo</h4>
<p>以上请求的样例如下：</p>
<pre>
No.1 FREE 0 (1, 1)
No.2 FREE 0 (1, 1)
No.3 IN_SERVICE 0 (1, 1)
No.99 FREE 0 (70, 79)
No.98 FREE 0 (1, 1)

No.99 GOING_TO_SERVICE [CR, (1, 2), (70, 72)]
No.98 IN_SERVICE [CR, (1, 2), (39, 79)]
[CR, (1, 2), (70, 72)]
[CR, (1, 3), (70, 71)]
[CR, (1, 4), (70, 70)]
[CR, (1, 5), (70, 69)]
[CR, (1, 6), (70, 88)]
</pre>
<p>其中：
* <code>No.3 IN_SERVICE 0 (1, 1)</code>为非法指令，解析失败
* ``（空行）为非法指令，解析失败
* <code>[CR, (1, 6), (70, 88)]</code>为非法指令，解析失败</p>
<p>注意：</p>
<ul>
<li>在进行读入的时候，<strong>成功读入的语句会在控制台上有反馈输出</strong>（即识别失败的语句将不会有输出，可以据此判定某行是否解析成功）</li>
<li>如果多条<strong>指令之间存在矛盾的话，以后面的为准</strong>（相关请求执行方式为顺序执行，故后面的同类请求会覆盖前面的请求）</li>
<li>在<code>load_file</code>文件中出现的出租车请求<strong>将会在系统start之后一并投入系统参与计算</strong>。</li>
</ul>
<h3>控制台输入</h3>
<ul>
<li>输入格式如<code>[CR, (x0, y0), (x1, y1)]</code>的指令（支持带空格），表示向出租车系统发出从<code>(x0, y0)</code>去<code>(x1, y1)</code>的请求。（即<strong>一般的出租车请求格式</strong>）</li>
<li>输入格式如<code>query_taxi &lt;taxi_id&gt;</code>的指令，表示查询编号为<code>taxi_id</code>的出租车。例如：<code>query_taxi 23</code>将查询<code>23</code>号出租车当前信息。</li>
<li>输入格式如<code>query_taxi_by_status &lt;taxi_status&gt;</code>的指令，表示查询状态为<code>taxi_status</code>的出租车，例如：<code>query_taxi_by_status GOING_TO_SERVICE</code>表示查询<code>GOING_TO_SERVICE</code>状态的出租车。<strong>其中&lt;taxi_status&gt;部分大小写不敏感，且_可以替换为-</strong>（即<code>going-to-service</code>与<code>GOING_TO_SERVICE</code>等价）。</li>
<li>
输入格式如<code>set_road (x0, y0) &lt;direction&gt; to &lt;status&gt;</code>的指令，表示将节点<code>(x0, y0)</code>与其指定方向上的对应相邻节点设置为指定的状态。
<ul>
<li>其中，<code>direction</code>为方向值（<strong>具体取值见上文</strong>）</li>
<li>
其中，<code>status</code>包含两种取值
<ul>
<li><code>CONNECT</code> 表示连接这两个点 </li>
<li><code>UNCONNECT</code> 表示断开这两个点</li>
</ul>
</li>
<li>其中，<strong>可以自由开闭任何相邻节点之间的道路</strong></li>
<li>其中 * 4，<strong>请测试者保证图的连通性</strong>。整个系统运转过程中将不会再次检查图连通性，一旦连通性被破坏，程序虽然不会crash，但是可能出现不可预料的结果。</li>
</ul>
</li>
</ul>
<h3>控制台输出</h3>
<ul>
<li>
控制台将输出出租车系统内的一些关键事件
<ul>
<li>
接单状况
<ul>
<li>是否成功分配出租车？</li>
<li>如果成功分配，出租车编号为多少？</li>
</ul>
</li>
<li>
出租车运行状况
<ul>
<li>出租车到达乘客位置</li>
<li>出租车到达乘客目的地 </li>
</ul>
</li>
</ul>
</li>
<li>
控制台将针对控制台输入的查询请求作即时回复
<ul>
<li>对于<code>query_taxi</code>，将输出<strong>出租车实时的状态信息</strong>（编号、信用积累、位置、状态）</li>
<li>对于<code>query_taxi_by_status</code>，将输出<strong>该状态出租车的查询结果</strong>（查询状态、结果数、符合条件的出租车编号） </li>
<li>对于<code>set_road</code>，将<strong>输出操作是否成功</strong>（只要两个点均合法即可成功，无论原先边状态如何）</li>
</ul>
</li>
<li>
各类异常操作信息
<ul>
<li>基础数据异常，例如：路网图存在诸如不连通、边越界之类的数据异常 </li>
<li>指令格式异常，例如：格式未识别的指令</li>
<li>指令数据异常，例如：参数越界或者查询结果不存在的指令 </li>
</ul>
</li>
</ul>
<h3>日志输出</h3>
<p>在日志（文件名<code>log.txt</code>）中，将有较为详细的系统调度信息，可以自行查看日志，此处不再赘述。</p>
<h3>GUI</h3>
<ul>
<li>GUI不使用<code>4*4</code>区域框</li>
<li>GUI将详细展示点的运动状态</li>
<li>GUI将展现出边的开闭状态</li>
</ul>
<h3>其他一些骚操作</h3>
<h4>路径动态选择策略</h4>
<p>按照之前的一些同学讨论，大致分为两派：</p>
<ul>
<li>打算开始时规划路径然后遇到被切断的路径再更新</li>
<li>打算一步一更新</li>
</ul>
<p>这两种方法各有优劣：</p>
<ul>
<li>前者很节约计算资源，但是机动性较差，无法做到实时避开高流量区域，用户体验较差（<del>可以想象为一个不会实时避开拥堵区域的百度地图导航，显然不可能有人想用这种东西的</del>）</li>
<li>后者机动性很高，可以做到实时避开拥堵区，但是计算资源消耗严重。尤其是在这样的一个系统中，很多时间单位都有一个最大公因数<code>500ms</code>，这意味着高并发状态下，每<code>500ms</code>就得应该一波最短路计算高峰。而本人程序在压测下，最短路计算引擎在一秒内大概只能计算<code>300</code>次左右的最短路。这将导致计算资源非常紧张（cpu占用飙升且居高不下）。</li>
</ul>
<p>于是，基于以上，<strong>本人采取了一种较为折中的策略</strong>：</p>
<ul>
<li>每次计算最短路后，行进<code>x</code>步后重新计算路线（<code>x</code>为[2, 6]的随机整数）</li>
<li>在每次行走的过程中，要是遇到断路，立刻退出循环并重新计算路线</li>
<li>直到走到终点为止</li>
</ul>
<p>这样的做法有以下一些好处：</p>
<ul>
<li>具有一定的机动性（显然）</li>
<li>同时节省计算资源（显然）</li>
<li>除此之外，由于<code>x</code>为一个随机数，所以意味着当同一批大量订单下达之后（假设100辆车全部进入待命状态），接下来各个车重新计算的时间点将被分散到（<code>2</code> <code>3</code> <code>4</code> <code>5</code> <code>6</code>五个时间点上，之后也将大致呈现均匀分布。故同一时间的计算压力将减少<code>80%</code>，系统运行将更加平稳）</li>
</ul>
<h4>官方<del>智障</del>GUI</h4>
<ul>
<li>官方GUI放置在<code>shit_like_code</code>包下</li>
<li>本人这次对官方GUI包进行了一点小的改动，当一辆车在等待红灯的时候，将会出现<i style="color: #ff00ff">紫色圈</i>。</li>
</ul>
<h2>注意事项</h2>
<ul>
<li>本程序中除非特殊说明，否则<strong>输入的枚举类参数均大小写不敏感，且<code>-</code>和<code>_</code>等价</strong>。</li>
<li>除上条之外，本程序中各处格式，除非特殊说明，否则<strong>一律大小写敏感</strong>。</li>
<li>本程序中各处输入格式，除非特殊说明，否则一律<strong>支持在元素之间带空格</strong>。例如：<code>[CR,(0, -0),( 1 , 1) ]</code>合法，而<code>[CR, (1 2, 3), (3, 2)]</code>不合法。</li>
<li>事件机制本质是基于抽象类+接口的<strong>面向接口编程</strong>。</li>
<li>由于图片和指导书存储在云端，如果本文档图片加载不出来，<strong>请连网</strong>。</li>
<li><code>detail.txt</code>日志文件配合<code>grep</code>命令食用更佳。（具体：<code>cat detail.txt|grep &quot;Taxi No.xxx&quot;</code>类似这样的；<del>Q：Windows用户怎么办？ A：那就人眼看吧，祝你不要看漏哦23333</del>）</li>
<li>本程序<code>repOK</code>均使用全局接口<code>ApplicationClassInterface</code>默认实现，除少数类情况特殊进行了重写之外（例如<code>Node</code>类），行为均为<strong>判定内部属性（包括私有属性）是否全部不为<code>null</code></strong>（Q：怎么实现的呢？为啥类中找不到<code>repOK</code>？ A：自行Google，<code>java interface default</code>，提高姿势水平） </li>
<li><del>请无视官方gui包的包名。Q: 这明明是真心话啊喵？ A: 闭嘴，大实话怎么能瞎说。</del></li>
<li>Q：jsf啥的怎么办？ A：随你咯<del>，120+个类欢迎慢慢找</del></li>
<li>Q：类Overview在哪？ A：每个类上头都有javadoc，等价于Overview。 </li>
<li>看不懂代码？<a href="javadoc\index.html">javadoc在此</a>，欢迎找bug，<del>给个笑容自己体会，找到bug算我输</del>。（<del>Q：那。。河蟹六系怎么办？ A：这种东西我才不在乎23333。比起这个，这么多次一个bug都没有过才叫寂寞呢</del>）</li>
</ul>
<p><img src="http://misaka-oss.oss-cn-beijing.aliyuncs.com/others/misaka-sister-1.jpg" /></p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
